<!DOCTYPE html>
<html lang="en-us" xmlns:th="http://www.thymeleaf.org">
<head th:include="common/iframeInclud :: header"></head>

<body class="gray-bg">

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>API配置管理
                        <small>编辑API配置</small>
                    </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>

                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <form class="form-horizontal" id="serviceForm">
                        <div class="tabs-container">
                            <ul class="nav nav-tabs">
                                <li class="active" style="width: 45%;text-align: center">
                                    <a data-toggle="tab" href="#service" ria-expanded="true">API配置</a>
                                </li>
                                <li class="" style="width: 45%;text-align: center">
                                    <a aria-expanded="false" data-toggle="tab" href="#endpointList">后端endpoint配置</a>
                                </li>
                                <li class="" style="float:right;text-align: right">
                                    <button class="btn btn-sm btn-primary" type="submit">保 存</button>
                                    <button class="btn btn-sm btn-default" onclick="removeIframeWithSwal()"
                                            type="button"> 关 闭
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active" id="service">
                                    <div class="panel-body">
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                API配置-基础信息
                                            </div>
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">调用地址</label>
                                                    <div class="col-sm-6">
                                                        <input class="form-control" name="serviceAddress" readonly
                                                               type="text" value="">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">API名称</label>
                                                    <div class="col-sm-6">
                                                        <input class="form-control" name="serviceId" type="hidden">
                                                        <input class="form-control" name="serviceName" type="text">
                                                    </div>
                                                    <span class="require_tip">*</span>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">启用状态</label>
                                                    <div class="col-sm-6">
                                                        <select class="form-control m-b selectpicker"
                                                                data-style="btn-white"
                                                                id="serviceEnabled"
                                                                name="serviceEnabled">
                                                            <option value="Y">启用</option>
                                                            <option value="N">禁用</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">调用前缀</label>
                                                    <div class="col-sm-6">
                                                        <input class="form-control" name="servicePrefix"
                                                               placeholder="/service" type="text">
                                                    </div>
                                                    <span class="require_tip">*</span>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-3 control-label">API描述</label>
                                                    <div class="col-sm-6">
								                            <textarea class="form-control" name="serviceDesc"
                                                                      placeholder="描述该服务的用途"
                                                                      rows="2"></textarea>
                                                    </div>
                                                    <span class="require_tip">*</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                API配置-路由信息
                                            </div>
                                            <div class="panel-body" id="service_router_panel">

                                            </div>
                                        </div>
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                API配置-鉴权信息
                                            </div>
                                            <div class="panel-body" id="service_auth_panel">

                                            </div>
                                        </div>
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                API配置-限流配置
                                            </div>
                                            <div class="panel-body" id="service_rate_limit_panel">

                                            </div>
                                        </div>
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                API配置-请求头配置
                                            </div>
                                            <div class="panel-body" id="service_modify_header_panel">

                                            </div>
                                        </div>
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                API配置-跨域配置
                                            </div>
                                            <div class="panel-body" id="service_cors_panel">

                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <div class="tab-pane" id="endpointList">
                                    <div class="panel-body" id="endpointListPanelBody">
                                        <p style="text-align: right">
                                            <button class="btn btn-primary" id="addEndpoint" type="button">
                                                新增endpoint配置
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    var osgGatewayUrl = [[${osgGatewayUrl}]];
</script>

<scpript th:include="common/iframeInclud :: footer"></scpript>
<scpript th:include="gateway/service/plugins/routeType"></scpript>
<scpript th:include="gateway/service/plugins/authType"></scpript>
<scpript th:include="gateway/service/plugins/rateLimit"></scpript>
<scpript th:include="gateway/service/plugins/modifyHeader"></scpript>
<scpript th:include="gateway/service/plugins/modifyHeader"></scpript>
<scpript th:include="gateway/service/plugins/createToken"></scpript>
<scpript th:include="gateway/service/plugins/silentRegistration"></scpript>
<scpript th:include="gateway/service/plugins/pathTransform"></scpript>
<scpript th:include="gateway/service/plugins/bodyTransform"></scpript>
<scpript th:include="gateway/service/plugins/signtureVerify"></scpript>
<scpript th:include="gateway/service/plugins/jarExecute"></scpript>
<scpript th:include="gateway/service/plugins/groovyExecute"></scpript>
<scpript th:include="gateway/service/plugins/rpcRouting"></scpript>
<scpript th:include="gateway/service/plugins/endpointHeader"></scpript>
<scpript th:include="gateway/service/plugins/ignoreAuth"></scpript>
<scpript th:include="gateway/service/plugins/accessToken"></scpript>
<scpript th:include="gateway/service/plugins/cacheResult"></scpript>
<scpript th:include="gateway/service/plugins/mock"></scpript>
<scpript th:include="gateway/service/plugins/cors"></scpript>
<scpript th:include="gateway/service/plugins/queryConverge"></scpript>
<scpript th:include="gateway/service/plugins/bodyValidate"></scpript>
<scpript th:include="gateway/service/plugins/circuitBreaker"></scpript>
<scpript th:include="gateway/service/endpointTmpl"></scpript>
<script th:src="@{/js/plugins/handlebars/handlebars-v4.0.12.js}" type="text/javascript"></script>
<script th:src="@{/js/appjs/gateway/service/add.js}" type="text/javascript"></script>
</body>

<script th:inline="javascript">
    var endpointPlugins = [[${endpointPlugins}]];
    $(function () {
        var serviceDTO = [[${serviceDTO}]];
        $("#service").find("[name='serviceId']").val(serviceDTO.serviceId);
        $("#service").find("[name='serviceName']").val(serviceDTO.serviceName);
        $("#service").find("[name='serviceDesc']").val(serviceDTO.serviceDesc);
        $("#service").find("[name='serviceEnabled']").val(serviceDTO.serviceEnabled);
        $("#service").find("[name='servicePrefix']").val(serviceDTO.servicePrefix);
        $("#service").find("[name='servicePrefix']").blur();
        $.each(serviceDTO.pluginDTOList, function (i, servicePlugin) {
            if (servicePlugin.pluginType == "AuthRequestPlugin") {
                authConfig.refreshDivByParam(servicePlugin.pluginParam, $('#service_auth_panel'));
            } else if (servicePlugin.pluginType == "RateLimitRequestPlugin") {
                rateLimitConfig.refreshDivByParam(servicePlugin.pluginParam, $('#service_rate_limit_panel'));
            } else if (servicePlugin.pluginType == "ModifyHeaderRequestPlugin") {
                serviceHeaderConfig.refreshDivByParam(servicePlugin.pluginParam, $('#service_modify_header_panel'), servicePlugin.pluginType);
            } else if (servicePlugin.pluginType == "ModifyHeaderResponsePlugin") {
                serviceHeaderConfig.refreshDivByParam(servicePlugin.pluginParam, $('#service_modify_header_panel'), servicePlugin.pluginType);
            } else if (servicePlugin.pluginType == "CorsRequestPlugin") {
                serviceCorsConfig.refreshDivByParam(servicePlugin.pluginParam, $('#service_cors_panel'));
            }
        })
        routeConfig.refreshDivByParam(serviceDTO.routerDTO, $('#service_router_panel'));
        serviceDTO.endpointDTOList.forEach(function (endpoint) {
            $("#addEndpoint").click();
            endpointConfig.refreshDivByParam(endpoint, $("#endpoint-" + endPointIndex))
        });
        closeAllEndpoint()
    })
</script>
</html>




